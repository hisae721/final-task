@startuml stopwatch-uml

' 列挙型定義

enum StopwatchState {
  Ready
  Running
  Paused
  Error
}

enum ButtonType {
  START
  PAUSE
  LAP
  RESET
}

' インターフェース定義

interface IStopwatchDisplay {
  + updateTime(formattedTime: string): void
  + showLaps(laps: LapTime[]): void
  + clearLaps(): void
  + showError(message: string): void
  + clearError(): void
  + setButtonState(state: StopwatchState, lapCount: number): void
  + enableButton(buttonType: ButtonType): void
  + disableButton(buttonType: ButtonType): void
  + showButton(buttonType: ButtonType): void
  + hideButton(buttonType: ButtonType): void
}

' クラス定義

class StopwatchController {
  - measurementEngine: MeasurementEngine
  - lapRecorder: LapRecorder
  - display: IStopwatchDisplay
  - validator: StopwatchValidator
  - formatter: TimeFormatter
  - updateIntervalId: number | null
  - lastClickTime: number
  - currentState: StopwatchState
  + constructor(display: IStopwatchDisplay)
  + handleStartClick(): void
  + handlePauseClick(): void
  + handleLapClick(): void
  + handleResetClick(): void
  + getCurrentState(): StopwatchState
  - startMeasurement(): void
  - pauseMeasurement(): void
  - resumeMeasurement(): void
  - resetMeasurement(): void
  - recordLap(): void
  - updateDisplay(): void
  - startDisplayUpdate(): void
  - stopDisplayUpdate(): void
  - checkMaxTimeExceeded(): void
  - handleMaxTimeExceeded(): void
  - transitionToState(newState: StopwatchState): void
  - syncStateWithEngine(): void
  - canProcessClick(currentTime: number): boolean
  - validateLapRecord(): boolean
}

class MeasurementEngine {
  - startTime: number | null
  - pausedTime: number
  - isRunning: boolean
  + constructor()
  + start(): void
  + pause(): number
  + resume(): void
  + reset(): void
  + getElapsedTime(): number
  + isActive(): boolean
}

class LapRecorder {
  - laps: LapTime[]
  - maxLaps: number
  - lastTotalTime: number
  + constructor(maxLaps: number)
  + recordLap(currentTotalTime: number): boolean
  + getLaps(): LapTime[]
  + getLastLapNumber(): number
  + clear(): void
  + isFull(): boolean
  + getLapCount(): number
  + canRecord(): boolean
  - calculateLapTime(currentTotal: number): number
  - createLapTime(lapNumber: number, lapTime: number, totalTime: number): LapTime
}

class LapTime {
  + lapNumber: number
  + lapTime: number
  + totalTime: number
  + constructor(lapNumber: number, lapTime: number, totalTime: number)
}

class TimeFormatter {
  + format(milliseconds: number): string
  + {static} padZero(num: number, digits: number): string
  - extractHours(milliseconds: number): number
  - extractMinutes(milliseconds: number): number
  - extractSeconds(milliseconds: number): number
  - extractMilliseconds(milliseconds: number): number
}

class StopwatchValidator {
  - maxTimeMs: number
  - minClickInterval: number
  - maxLaps: number
  + constructor()
  + isOverMaxTime(milliseconds: number): boolean
  + canRecordLap(lapCount: number): boolean
  + isClickIntervalValid(lastClickTime: number, currentTime: number): boolean
  + validateElapsedTime(milliseconds: number): boolean
  + getMaxTimeMs(): number
  + getMinClickIntervalMs(): number
}

class DomDisplay {
  - timeElement: HTMLElement
  - lapListElement: HTMLElement
  - startButton: HTMLButtonElement
  - pauseButton: HTMLButtonElement
  - lapButton: HTMLButtonElement
  - resetButton: HTMLButtonElement
  - errorElement: HTMLElement
  + constructor()
  + updateTime(formattedTime: string): void
  + showLaps(laps: LapTime[]): void
  + clearLaps(): void
  + showError(message: string): void
  + clearError(): void
  + setButtonState(state: StopwatchState, lapCount: number): void
  + enableButton(buttonType: ButtonType): void
  + disableButton(buttonType: ButtonType): void
  + showButton(buttonType: ButtonType): void
  + hideButton(buttonType: ButtonType): void
  - updateStartPauseButton(state: StopwatchState): void
  - updateLapButton(state: StopwatchState, lapCount: number): void
  - updateResetButton(state: StopwatchState): void
  - getButtonElement(buttonType: ButtonType): HTMLButtonElement
  - renderLapList(laps: LapTime[]): void
}

class Config {
  + {static} MAX_TIME_MS: number
  + {static} MIN_CLICK_INTERVAL_MS: number
  + {static} MAX_LAPS: number
  + {static} DISPLAY_UPDATE_INTERVAL_MS: number
  + {static} MAX_HOURS: number
  + {static} ERROR_MESSAGE_MAX_TIME: string
  + {static} ERROR_MESSAGE_LAP_FULL: string
}

' 実装関係

DomDisplay ..|> IStopwatchDisplay

' 使用関係

StopwatchController --> MeasurementEngine 
StopwatchController --> LapRecorder 
StopwatchController --> IStopwatchDisplay 
StopwatchController --> StopwatchValidator 
StopwatchController --> TimeFormatter 
StopwatchController --> StopwatchState 

MeasurementEngine --> StopwatchState 

LapRecorder "1" *-- "0..5" LapTime 

DomDisplay --> StopwatchState 
DomDisplay --> ButtonType 

StopwatchController ..> Config 
MeasurementEngine ..> Config 
LapRecorder ..> Config 
TimeFormatter ..> Config 
StopwatchValidator ..> Config 

@enduml
