@startuml stopwatch-sequence-uml

actor User
boundary UI
participant StopwatchController as Controller
participant StopwatchStateManager as StateManager
participant DisplayUpdateManager as UpdateManager
participant MeasurementEngine as Engine
participant LapRecorder as Lap
participant TimeFormatter as Formatter
participant StopwatchValidator as Validator
participant DomDisplay as Display

== 初期状態 ==

UI -> Display: new DomDisplay()
UI -> Formatter: new TimeFormatter()
UI -> Validator: new StopwatchValidator()
UI -> StateManager: new StopwatchStateManager(display, formatter, validator)
StateManager -> StateManager: currentState = Ready

UI -> Engine: new MeasurementEngine()
UI -> Lap: new LapRecorder(5)
UI -> UpdateManager: new DisplayUpdateManager(engine, stateManager, lapRecorder)
UpdateManager -> UpdateManager: updateIntervalId = null

UI -> Controller: new StopwatchController(stateManager, updateManager, engine, lap, validator)
Controller -> Controller: lastClickTime = 0

StateManager -> Display: setButtonState(Ready, 0)
Display --> User: 初期画面表示\nスタートボタン: 有効\nその他: 無効

note right of StateManager
  **初期化時の責務分担**
  ・Controller: lastClickTime管理
  ・StateManager: 状態管理 + formatter/validator所有
  ・UpdateManager: 画面更新制御 + lapRecorder参照
end note

== スタート ==

User -> UI: スタートボタン押下
UI -> Controller: handleStartClick()

group 連打防止チェック（200ms）
    Controller -> Controller: currentTime = Date.now()
    Controller -> Validator: isClickIntervalValid(lastClickTime, currentTime)
    Validator --> Controller: isValid
    
    alt クリック間隔が200ms未満
        Validator --> Controller: false
        Controller --> UI: 処理を無視（何もしない）
        note right of Controller
          クリック受付失敗時は
          lastClickTimeを更新しない
        end note
    else クリック間隔が200ms以上（正常）
        Controller -> Controller: lastClickTime = currentTime
        note right of Controller
          **lastClickTime更新**
          クリック受付成功時のみ更新
        end note

        Controller -> StateManager: canStartMeasurement()
        StateManager --> Controller: true
        
        alt 初回スタート（Ready状態から）
            Controller -> Engine: start()
            Engine --> Controller: void
            
            note right of Controller
              **Ready → Running**
              初回の計測開始
            end note
            
        else 再開（Paused状態から）
            Controller -> Engine: resume()
            Engine --> Controller: void
            
            note right of Controller
              **Paused → Running**
              一時停止からの再開
              停止時点から計測継続
            end note
        end
        
        Controller -> Lap: getLapCount()
        Lap --> Controller: lapCount
        
        Controller -> StateManager: transitionToRunning(lapCount)
        StateManager -> StateManager: transitionToState(Running, lapCount)
        StateManager -> Display: setButtonState(Running, lapCount)
        Display --> User: 一時停止ボタン: 表示・有効\nラップ・リセット: 有効\nスタートボタン: 非表示
        
        Controller -> UpdateManager: startUpdate()
        
        note right of UpdateManager
          **定期更新の開始**
          ・既にupdateIntervalIdが存在する場合は
            clearInterval()で既存を停止
          ・setInterval()で100ms間隔で
            updateDisplay()を実行開始
          ・updateIntervalIdに保存
        end note
    end
end

== 計測中（定期更新） ==

loop every 100ms
    UpdateManager -> UpdateManager: updateDisplay()
    
    UpdateManager -> Engine: getElapsedTime()
    Engine --> UpdateManager: elapsedTime (ミリ秒)
    
    UpdateManager -> Lap: getLapCount()
    Lap --> UpdateManager: lapCount
    
    UpdateManager -> StateManager: checkAndHandleMaxTime(elapsedTime, lapCount)
    StateManager -> Validator: isOverMaxTime(elapsedTime)
    Validator --> StateManager: isOver
    
    alt 最大時間超過（99:59:59.99）
        StateManager -> Engine: pause()
        Engine --> StateManager: pausedTime
        
        UpdateManager -> UpdateManager: stopUpdate()
        note right of UpdateManager
          **定期更新の停止**
          ・clearInterval(updateIntervalId)
          ・updateIntervalId = null
          ・以降updateDisplay()は呼ばれない
        end note
        
        StateManager -> StateManager: transitionToState(Error, lapCount)
        StateManager -> Display: setButtonState(Error, lapCount)
        StateManager -> StateManager: showErrorMessage("最大時間を超過しました")
        StateManager -> Display: showError("最大時間を超過しました")
        Display --> User: エラーメッセージ表示\n全ボタン無効\nリセットのみ有効
        
        note right of StateManager
          **Error状態の特徴**
          ・計測停止
          ・定期更新停止
          ・リセットボタンのみ有効
          ・エラーメッセージ表示
          
          **UI更新の一元管理**
          validator判定 → 状態遷移 → エラー表示
          すべてStateManagerで完結
        end note
        
    else 時間内（正常）
        StateManager -> Formatter: format(elapsedTime)
        Formatter --> StateManager: "00:00:12.34"
        
        StateManager -> Display: updateTime("00:00:12.34")
        Display --> User: 表示更新
        
        note right of StateManager
          **フォーマット処理の内包**
          formatter.format()を内部で呼び出し
          formattedStringをDisplayに渡す
        end note
    end
end

== ラップ記録 ==

User -> UI: ラップボタン押下
UI -> Controller: handleLapClick()

ref over Controller, Validator
  連打防止チェック（200ms）
  詳細は「スタート」セクション参照
end ref

Controller -> StateManager: canRecordLap()
StateManager --> Controller: canRecord

alt 現在の状態がRunning以外
    StateManager --> Controller: false
    note right of Controller
      Running状態でなければ
      ラップ記録不可
    end note
else 現在の状態がRunning
    StateManager --> Controller: true
    
    Controller -> Lap: canRecord()
    Lap --> Controller: canRecord
    
    alt ラップが5件に達している
        Lap --> Controller: false
        Controller -> StateManager: showErrorMessage("ラップは最大5件までです")
        StateManager -> Display: showError("ラップは最大5件までです")
        Display --> User: エラーメッセージ表示
        
        note right of StateManager
          **エラー表示の一元化**
          すべてのエラー表示は
          StateManagerを経由
        end note
        
        note right of Controller
          ラップ上限エラー時も
          計測は継続する
        end note
        
    else ラップ記録可能（5件未満）
        Lap --> Controller: true
        
        Controller -> Engine: getElapsedTime()
        Engine --> Controller: 12345 (ミリ秒)
        
        Controller -> Lap: recordLap(12345)
        Lap -> Lap: calculateLapTime(12345)
        Lap -> Lap: createLapTime(1, 12345, 12345)
        Lap -> Lap: lastTotalTime = 12345
        Lap --> Controller: true
        
        Controller -> Lap: getLaps()
        Lap --> Controller: [LapTime{1, 12345, 12345}]
        
        Controller -> Display: showLaps([...])
        Display --> User: ラップ履歴表示
        
        note right of Display
          **ラップ履歴の表示**
          ・最新のラップが上（降順）
          ・最大5件まで表示
          ・6件目は記録されない
        end note
    end
end

== 一時停止 ==

User -> UI: 一時停止ボタン押下
UI -> Controller: handlePauseClick()

ref over Controller, Validator
  連打防止チェック（200ms）
  詳細は「スタート」セクション参照
end ref

Controller -> StateManager: canPauseMeasurement()
StateManager --> Controller: true

Controller -> Engine: pause()
Engine --> Controller: pausedTime

Controller -> UpdateManager: stopUpdate()

note right of UpdateManager
  **定期更新の確実な停止**
  ・clearInterval(updateIntervalId)
  ・updateIntervalId = null
  ・二重起動防止のため必須
end note

Controller -> Lap: getLapCount()
Lap --> Controller: lapCount

Controller -> StateManager: transitionToPaused(lapCount)
StateManager -> StateManager: transitionToState(Paused, lapCount)
StateManager -> Display: setButtonState(Paused, lapCount)
Display --> User: スタートボタン: 表示・有効\n一時停止: 非表示\nラップ: 無効\nリセット: 有効

note right of Controller
  **Running → Paused**
  一時停止後、スタートボタンで再開可能
  （再開時は「スタート」セクションの
  　「再開（Paused状態から）」に遷移）
end note

== リセット（一時停止中から） ==

User -> UI: リセットボタン押下
UI -> Controller: handleResetClick()

ref over Controller, Validator
  連打防止チェック（200ms）
  詳細は「スタート」セクション参照
end ref

Controller -> StateManager: getCurrentState()
StateManager --> Controller: currentState

alt 現在の状態がError
    note right of Controller
      **Error状態からの復旧**
      リセット操作でReady状態へ復帰
    end note
    
    Controller -> StateManager: clearErrorMessage()
    StateManager -> Display: clearError()
    Display --> User: エラーメッセージクリア
end

Controller -> Engine: reset()
Engine --> Controller: void

Controller -> Lap: clear()
Lap -> Lap: lastTotalTime = 0
Lap --> Controller: void

Controller -> Display: clearLaps()
Display --> User: ラップ履歴クリア

note right of Display
  **ラップ履歴の同期処理**
  clearLaps()でUI上の
  ラップ表示も完全にクリア
end note

Controller -> UpdateManager: stopUpdate()
note right of UpdateManager
  念のため定期更新を停止
  （既に停止済みの場合も安全）
end note

Controller -> StateManager: transitionToReady()
StateManager -> StateManager: transitionToState(Ready, 0)
StateManager -> Display: setButtonState(Ready, 0)

Controller -> StateManager: updateTimeDisplay(0)
StateManager -> Formatter: format(0)
Formatter --> StateManager: "00:00:00.00"
StateManager -> Display: updateTime("00:00:00.00")

Display --> User: 表示: 00:00:00.00\nスタートボタン: 有効\nラップ・リセット: 無効

@enduml